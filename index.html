<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 20px; }
      button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
  </head>
  <body>
    <h1>Descargar Reporte</h1>
    <p>Haz clic en el botón para descargar el reporte en formato CSV.</p>
    <button id="downloadButton">Descargar Reporte</button>

    <script>
      // Añade un listener al botón de descarga.
      document.getElementById("downloadButton").addEventListener("click", downloadReport);

      function downloadReport() {
        // Muestra un mensaje al usuario y deshabilita el botón.
        this.textContent = "Generando...";
        this.disabled = true;

        // Llama a la función del servidor (Code.gs) para obtener los datos.
        google.script.run
          .withSuccessHandler(createDownloadLink)
          .withFailureHandler(onFailure)
          .generateReportData();
      }

      /**
       * Esta función se ejecuta cuando el servidor devuelve los datos del reporte.
       * Crea un enlace de descarga invisible y hace clic en él.
       */
      function createDownloadLink(reportContent) {
        const fileName = "reporte-" + new Date().toISOString().slice(0, 10) + ".csv";
        const blob = new Blob([reportContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");

        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", fileName);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
        
        // Reactiva el botón de descarga.
        const button = document.getElementById("downloadButton");
        button.textContent = "Descargar Reporte";
        button.disabled = false;
      }

      function onFailure(error) {
        alert("Error al generar el reporte: " + error.message);
        const button = document.getElementById("downloadButton");
        button.textContent = "Descargar Reporte";
        button.disabled = false;
      }
    </script>
  </body>
</html>
